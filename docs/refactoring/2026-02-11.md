# Refactoring Log — 2026-02-11

## Reviewed `src/commands/init.c`

The `init` command was extracted from the monolithic `main.c` as part of the
modular architecture refactoring. It is the simplest of the three commands and
already reads well, but there are a few things worth tightening up.

### What works
- **`ensure_dir` helper** — clean single-responsibility function that handles
  `mkdir` + `EEXIST` tolerance in one place.
- **Uses shared constants** — `CGIT_DIR`, `CGIT_OBJECTS_DIR`, `CGIT_REFS_DIR`,
  `CGIT_HEAD_FILE` all come from `common.h`, no hardcoded strings.
- **Reinit detection** — the `reinit` flag avoids overwriting an existing `HEAD`
  file, matching real git behavior.

### Observations and potential improvements
1. **`ensure_dir` duplicates the mkdir+EEXIST pattern from `handle_init`** —
   Lines 20-27 manually do `mkdir` → check `EEXIST` → set `reinit`, while
   `ensure_dir` does the same minus the reinit flag. A possible consolidation:
   make `ensure_dir` return a tri-state (created / already existed / error) and
   use it for the top-level `.cgit` directory too, deriving `reinit` from the
   return value.

2. **`HEAD` write has no error check on `fprintf`/`fclose`** — `fopen` failure
   is handled, but the write itself could fail (e.g., disk full). Checking the
   return of `fprintf` and `fclose` would make the function robust against I/O
   errors during the write.

